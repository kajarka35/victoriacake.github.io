<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrador - Gestión de Productos</title>
  <link rel="stylesheet" href="../css/styles_dark_optimizado.css">
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&family=Great+Vibes&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
</head>
<body>
  <header>
    <h1>Panel de Administración Victoria Cake</h1>
    <div id="logout-container">
      <button id="cerrar-sesion">🚪 Cerrar sesión</button>
      <button onclick="location.href='index.html'">🏠 Inicio</button>
    </div>
  </header>

  <div id="controles">
    <input type="search" id="buscar-input" placeholder="Buscar productos por nombre...">
    <select id="ordenar-select">
      <option value="nombre">Ordenar por nombre</option>
      <option value="creado">Ordenar por fecha</option>
    </select>
    <button id="vista-toggle">🔃 Cambiar vista</button>
  </div>

  <form id="formulario-producto">
    <input type="text" id="nombre" placeholder="Nombre del producto" required>
    <input type="text" id="descripcion" placeholder="Descripción" required>
    <input type="number" id="precio" placeholder="Precio" required>
    <input type="url" id="imagen" placeholder="URL de imagen" required readonly>
    <button type="button" id="subir-imagen-cloudinary">📷 Subir Imagen</button>
    <img id="preview" src="" alt="Vista previa" style="display:none; max-width:100%; margin-top:10px; border-radius:12px;" />
    <button type="submit">📦 Guardar producto</button>
    <button type="button" id="cancelar-edicion" style="display:none">❌ Cancelar edición</button>
  </form>

  <div id="productos-lista" class="grid"></div>
  <div id="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js';
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, updateDoc, doc, query, orderBy, getDoc } from 'https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js';
    import { firebaseConfig } from '../js/firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    const lista = document.getElementById('productos-lista');
    const ordenarSelect = document.getElementById('ordenar-select');
    const vistaToggle = document.getElementById('vista-toggle');
    const buscarInput = document.getElementById('buscar-input');
    const form = document.getElementById('formulario-producto');
    const cancelarBtn = document.getElementById('cancelar-edicion');
    const logoutBtn = document.getElementById('cerrar-sesion');
    const toast = document.getElementById('toast');
    const inputUrl = document.getElementById("imagen");
    const preview = document.getElementById("preview");

    let vista = localStorage.getItem('vista') || 'grid';
    ordenarSelect.value = localStorage.getItem('orden') || 'nombre';
    let productosCache = [];
    let editandoId = null;

    function mostrarToast(msg) {
      toast.textContent = msg;
      toast.classList.add('mostrar');
      setTimeout(() => toast.classList.remove('mostrar'), 3000);
    }

    const aplicarVista = () => {
      lista.className = vista;
    };

    const render = (productos) => {
      lista.innerHTML = '';
      aplicarVista();
      productos.forEach((p) => {
        const div = document.createElement('div');
        div.className = `producto-card ${vista === 'lista' ? 'lista' : ''}`;
        div.innerHTML = `
          <img src="${p.imagen}" alt="${p.nombre}" />
          <div>
            <h3>${p.nombre}</h3>
            <p>${p.descripcion}</p>
            <p><strong>$${(p.precio || 0).toLocaleString()}</strong></p>
            <div class="acciones">
              <button class="editar" data-id="${p.id}">✏️ Editar</button>
              <button class="eliminar" data-id="${p.id}">🗑 Eliminar</button>
            </div>
          </div>
        `;
        lista.appendChild(div);
      });

      document.querySelectorAll('.eliminar').forEach(btn => {
        btn.onclick = async () => {
          if (confirm('¿Eliminar producto?')) {
            await deleteDoc(doc(db, 'productos', btn.dataset.id));
            cargarProductos();
            mostrarToast('🗑 Producto eliminado');
          }
        };
      });

      document.querySelectorAll('.editar').forEach(btn => {
        btn.onclick = () => {
          const prod = productosCache.find(p => p.id === btn.dataset.id);
          if (prod) {
            form.nombre.value = prod.nombre;
            form.descripcion.value = prod.descripcion;
            form.precio.value = prod.precio;
            form.imagen.value = prod.imagen;
            preview.src = prod.imagen;
            preview.style.display = 'block';
            editandoId = prod.id;
            cancelarBtn.style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        };
      });
    };

    const cargarProductos = async () => {
      const criterio = ordenarSelect.value;
      const q = query(collection(db, 'productos'), orderBy(criterio === 'creado' ? 'creado' : 'nombre'));
      const snapshot = await getDocs(q);
      productosCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      filtrarYRenderizar();
    };

    const filtrarYRenderizar = () => {
      const filtro = buscarInput.value.toLowerCase();
      const filtrados = productosCache.filter(p => p.nombre.toLowerCase().includes(filtro));
      render(filtrados);
    };

    buscarInput.addEventListener('input', filtrarYRenderizar);
    ordenarSelect.addEventListener('change', () => {
      localStorage.setItem('orden', ordenarSelect.value);
      cargarProductos();
    });
    vistaToggle.addEventListener('click', () => {
      vista = vista === 'grid' ? 'lista' : 'grid';
      localStorage.setItem('vista', vista);
      aplicarVista();
      filtrarYRenderizar();
    });

    cancelarBtn.addEventListener('click', () => {
      form.reset();
      preview.style.display = 'none';
      editandoId = null;
      cancelarBtn.style.display = 'none';
    });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const imagenUrl = inputUrl.value.trim();

      if (!imagenUrl) return mostrarToast("⚠️ Por favor sube una imagen del producto.");
      if (!imagenUrl.startsWith("https://res.cloudinary.com/")) return mostrarToast("⚠️ La imagen debe ser subida a través de Cloudinary.");

      const data = {
        nombre: form.nombre.value.trim(),
        descripcion: form.descripcion.value.trim(),
        precio: parseFloat(form.precio.value),
        imagen: imagenUrl,
        creado: new Date()
      };

      if (editandoId) {
        await updateDoc(doc(db, 'productos', editandoId), data);
        editandoId = null;
        cancelarBtn.style.display = 'none';
        mostrarToast('✏️ Producto actualizado');
      } else {
        await addDoc(collection(db, 'productos'), data);
        mostrarToast('✅ Producto agregado');
      }

      form.reset();
      preview.style.display = 'none';
      cargarProductos();
    });

    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      mostrarToast('🚪 Cerrando sesión...');
      setTimeout(() => window.location.href = 'index.html', 1500);
    });

    onAuthStateChanged(auth, async user => {
      if (!user) return window.location.href = 'index.html';
      const rolSnap = await getDoc(doc(db, 'roles', user.uid));
      if (!rolSnap.exists() || rolSnap.data().rol !== 'admin') {
        mostrarToast('Acceso denegado: No eres administrador');
        setTimeout(() => window.location.href = 'index.html', 2000);
      } else {
        aplicarVista();
        cargarProductos();
      }
    });

    const cloudinaryWidget = cloudinary.createUploadWidget({
      cloudName: 'dmcxjdh7s',
      uploadPreset: 'ml_default'
    }, (error, result) => {
      if (error) {
        console.error("❌ Error en widget Cloudinary:", error);
      }
      if (result && result.event === "success") {
        const url = result.info.secure_url;
        inputUrl.value = url;
        preview.src = url;
        preview.style.display = 'block';
        mostrarToast('📸 Imagen cargada con éxito');
      }
    });

    document.getElementById("subir-imagen-cloudinary").addEventListener("click", () => {
      cloudinaryWidget.open();
    });
  </script>
</body>
</html>
